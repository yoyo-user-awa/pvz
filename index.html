<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Garden Defense — 塔防</title>
  <style>
    body{margin:0;background:#111;display:flex;user-select:none;overflow:hidden}
    #left{width:120px;height:100vh;background:#2a2;display:flex;flex-direction:column;align-items:center;padding-top:10px}
    .card{width:100px;height:100px;margin:5px;border:2px solid #fff;border-radius:8px;cursor:pointer;position:relative;background:#444;color:#fff;font:14px/100px Arial;text-align:center}
    .card.cooling{background:#666;cursor:not-allowed}
    .coolBar{position:absolute;bottom:0;left:0;height:4px;background:#fffb;transition:width linear}
    #mainCanvas{background:#222;display:block}
    #info{position:absolute;top:10px;left:130px;color:#fff;font:18px Arial}
  </style>
</head>
<body>
<div id="left">
  <div class="card" data-type="pea" data-cost="100" data-cool="3">豌豆<br>☀100</div>
  <div class="card" data-type="nut" data-cost="50" data-cool="5">坚果<br>☀50</div>
</div>
<div id="info">阳光: <span id="sun">150</span> | 波次: <span id="wave">0</span> | 存活: <span id="zCount">0</span></div>
<canvas id="mainCanvas" width="900" height="600"></canvas>

<script>
/* ===== 基本常量和画布 ===== */
const canvas=document.getElementById('mainCanvas'),ctx=canvas.getContext('2d');
const CELL=60,ROW=10,COL=15;
let sun=150,wave=0,zCount=0,paused=false;
const plants=[],zombies=[],bullets=[];
/* ===== 阳光更新 ===== */
function updateSun(num){
  sun+=num;
  document.getElementById('sun').textContent=sun;
}
/* ===== 冷却系统 ===== */
const coolTick={};   // {cardDOM: 剩余秒数}
function startCool(cardEl,seconds){
  coolTick[cardEl]=seconds;
  cardEl.classList.add('cooling');
  const bar=document.createElement('div');
  bar.className='coolBar';bar.style.width='100%';
  cardEl.appendChild(bar);
}
function coolLoop(dt){
  for(let el in coolTick){
    coolTick[el]-=dt;
    const bar=el.querySelector('.coolBar');
    if(bar)bar.style.width=(coolTick[el]/parseFloat(el.dataset.cool)*100)+'%';
    if(coolTick[el]<=0){
      delete coolTick[el];
      el.classList.remove('cooling');
      el.removeChild(bar);
    }
  }
}
/* ===== 植物类 ===== */
class Plant{
  constructor(x,y,type){
    this.x=x;this.y=y;this.type=type;this.hp=300;
    this.shootTimer=0;
  }
  update(dt){
    if(this.type==='pea'){
      this.shootTimer+=dt;
      if(this.shootTimer>1.5){
        this.shootTimer=0;
        bullets.push(new Bullet(this.x+CELL/2,this.y+CELL/2));
      }
    }
  }
  draw(){
    ctx.fillStyle=this.type==='pea'?'#3f3':'#963';
    ctx.fillRect(this.x+10,this.y+10,CELL-20,CELL-20);
  }
}
/* ===== 僵尸类 ===== */
class Zombie{
  constructor(x,y){
    this.x=x;this.y=y;this.hp=200;this.speed=20;
  }
  update(dt){
    this.x-=this.speed*dt;
    if(this.x<0){/* 到家 */this.hp=0; }
  }
  draw(){
    ctx.fillStyle='#aa2';ctx.fillRect(this.x,this.y+15,CELL-10,CELL-30);
  }
}
/* ===== 子弹类 ===== */
class Bullet{
  constructor(x,y){this.x=x;this.y=y;this.speed=400;}
  update(dt){this.x+=this.speed*dt;}
  draw(){ctx.fillStyle='#ff0';ctx.beginPath();ctx.arc(this.x,this.y,6,0,Math.PI*2);ctx.fill();}
}
/* ===== 放置植物 ===== */
let selectedType=null;
document.querySelectorAll('.card').forEach(card=>{
  card.addEventListener('click',()=>{
    if(card.classList.contains('cooling'))return;
    selectedType=card.dataset.type;
  });
});
canvas.addEventListener('click',e=>{
  if(!selectedType||paused)return;
  const rect=canvas.getBoundingClientRect(),
        cx=e.clientX-rect.left,gy=e.clientY-rect.top,
        col=Math.floor(cx/CELL),row=Math.floor(gy/CELL),
        x=col*CELL,y=row*CELL;
  // 格子占位检测
  if(plants.some(p=>p.x===x&&p.y===y))return;
  const card=document.querySelector(`.card[data-type="${selectedType}"]`),
        cost=parseInt(card.dataset.cool)*30;   // 用冷却秒数*30当阳光价
  if(sun<cost)return;
  updateSun(-cost);
  plants.push(new Plant(x,y,selectedType));
  startCool(card,parseInt(card.dataset.cool));
  selectedType=null;
});
/* ===== 刷怪 ===== */
let zombieTimer=0;
function spawnLogic(dt){
  zombieTimer+=dt;
  if(zombieTimer>5){   // 每5秒刷一只
    zombieTimer=0;
    const row=Math.floor(Math.random()*ROW)*CELL;
    zombies.push(new Zombie(canvas.width,row));
    zCount++;
  }
}
/* ===== 主循环 ===== */
let last=0;
function gameLoop(timestamp){
  const dt=Math.min(0.05,(timestamp-last)/1000); last=timestamp;
  if(!paused){
    coolTick&&coolLoop(dt);
    plants.forEach(p=>p.update(dt));
    zombies.forEach(z=>z.update(dt));
    bullets.forEach(b=>b.update(dt));
    spawnLogic(dt);
    // 碰撞检测
    bullets.forEach(b=>{
      zombies.forEach(z=>{
        if(Math.abs(b.x-z.x)<CELL/2&&Math.abs(b.y-z.y)<CELL/2){
          b.x=9999; z.hp-=50;
        }
      });
    });
    zombies.forEach(z=>{
      plants.forEach(p=>{
        if(Math.abs(z.x-p.x)<CELL/2&&Math.abs(z.y-p.y)<CELL/2){
          p.hp-=20*dt; if(p.hp<=0)plants.splice(plants.indexOf(p),1);
        }
      });
    });
    // 死亡清理
    zombies.filter(z=>z.hp<=0||z.x<0).forEach(z=>zCount--);
    zombies.splice(0,zombies.length,...zombies.filter(z=>z.hp>0&&z.x>=0));
    bullets.splice(0,bullets.length,...bullets.filter(b=>b.x<canvas.width));
  }
  // 绘制
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<=ROW;i++)for(let j=0;j<=COL;j++){ctx.strokeStyle='#444';ctx.strokeRect(j*CELL,i*CELL,CELL,CELL);}
  plants.forEach(p=>p.draw());
  zombies.forEach(z=>z.draw());
  bullets.forEach(b=>b.draw());
  document.getElementById('wave').textContent=wave;
  document.getElementById('zCount').textContent=zCount;
  requestAnimationFrame(gameLoop);
}
/* ===== 阳光自然增长 ===== */
setInterval(()=>updateSun(25),1200);
/* ===== 暂停控制 ===== */
addEventListener('keydown',e=>{if(e.key.toLowerCase()==='p')paused=!paused;});
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
